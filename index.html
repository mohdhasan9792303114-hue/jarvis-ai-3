<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>JARVIS AI CORE</title>

<link rel="manifest" href="manifest.json">

<style>

body{
background:#0f172a;
color:white;
font-family:Arial;
margin:0;
display:flex;
}

/* ===== SIDEBAR ===== */

#sidebar{
width:260px;
height:100vh;
background:#020617;
border-right:1px solid #0ea5e9;
overflow:auto;
padding:12px;
position:fixed;
left:-260px;
top:0;
transition:0.3s;
z-index:999;
}

#sidebar.open{
left:0;
}

.tab{
background:#1e293b;
margin:5px;
padding:8px;
cursor:pointer;
display:flex;
justify-content:space-between;
}

.deleteBtn{
color:red;
cursor:pointer;
}

/* ===== MAIN ===== */

#main{
flex:1;
display:flex;
flex-direction:column;
margin-left:0;
width:100%;
}

header{
background:#0ea5e9;
padding:12px;
text-align:center;
}

#userEmail{
font-size:12px;
color:#e2e8f0;
}

#chat{
flex:1;
overflow:auto;
padding:10px;
}

textarea{
width:100%;
min-height:50px;
max-height:120px;
background:#1e293b;
color:white;
border:none;
resize:none;
overflow:auto;
}

button{
padding:10px;
margin:3px;
background:#0ea5e9;
color:white;
border:none;
}

.user{color:#34d399;}
.ai{color:#38bdf8;}

</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->

<div id="sidebar">

<h3>Chats</h3>
<div id="tabs"></div>

<button onclick="newChat()">‚ûï New Chat</button>
<button onclick="jarvisLogin()">‚òÅ Cloud Login</button>

</div>

<!-- ===== MAIN ===== -->

<div id="main">

<header>
üß† JARVIS AI CORE
<div id="userEmail">Not Logged In</div>
</header>

<div id="chat"></div>

<textarea id="input"></textarea>

<div>
<button onclick="send()">Send</button>
<button onclick="voiceInput()">üé§ Voice</button>
</div>

</div>

<script>

/* ===== DATABASE ===== */

let db = JSON.parse(localStorage.getItem("jarvisDB")) || {

tabs:{default:[]},
activeTab:"default",

memory:{},
vector:[],

settings:{
language:"en",
voice:false
}

};

function save(){
localStorage.setItem("jarvisDB", JSON.stringify(db));
}

/* ===== DOM ===== */

let chat = document.getElementById("chat");
let input = document.getElementById("input");
let tabs = document.getElementById("tabs");

/* ===== CHAT RENDER ===== */

function render(role,text){

let div = document.createElement("div");
div.className = role;
div.textContent = (role==="user"?"You: ":"Jarvis: ")+text;

chat.appendChild(div);
chat.scrollTop = chat.scrollHeight;

}

/* ===== ADD MESSAGE ===== */

function add(role,text){

render(role,text);

db.tabs[db.activeTab].push({role,text});
save();

/* Cloud Save */
if(window.saveCloudMemory){
saveCloudMemory();
}

/* Voice Only If Enabled */
if(role==="ai" && db.settings.voice){
speak(text);
}

}

/* ===== CHAT DELETE ===== */

function deleteChat(id){

if(confirm("Delete Chat?")){
delete db.tabs[id];
db.activeTab="default";
save();
loadTabs();
loadChat();
}

}

/* ===== MULTI CHAT ===== */

function newChat(){

let id = "chat"+Date.now();
db.tabs[id]=[];
db.activeTab=id;
save();

loadTabs();
loadChat();

}

function loadTabs(){

tabs.innerHTML="";

Object.keys(db.tabs).forEach(t=>{

let d=document.createElement("div");
d.className="tab";

d.innerHTML=`
<span onclick="switchChat('${t}')">${t}</span>
<span class="deleteBtn" onclick="deleteChat('${t}')">‚ùå</span>
`;

tabs.appendChild(d);

});

}

function switchChat(id){

db.activeTab=id;
loadChat();

/* Auto close sidebar */
document.getElementById("sidebar").classList.remove("open");

}

function loadChat(){

chat.innerHTML="";

(db.tabs[db.activeTab]||[]).forEach(m=>{
render(m.role,m.text);
});

}

/* ===== VOICE OUTPUT ===== */

function speak(text){

let speech = new SpeechSynthesisUtterance(text);
speech.lang = "en-US";

speechSynthesis.cancel();
speechSynthesis.speak(speech);

}

/* ===== VOICE INPUT ===== */

function voiceInput(){

db.settings.voice=true;
save();

let SR = window.SpeechRecognition || window.webkitSpeechRecognition;

if(!SR){
alert("Voice Not Supported");
return;
}

let r = new SR();

r.onresult=e=>{
input.value=e.results[0][0].transcript;
send();
};

r.start();

}

/* ===== VECTOR MEMORY ===== */

function vectorStore(q,a){
db.vector.push({q,a});
save();
}

function vectorSearch(text){

for(let v of db.vector){
if(text.includes(v.q)) return v.a;
}

return null;
}

/* ===== AI CORE ===== */

async function think(text){

text=text.toLowerCase();

if(text.startsWith("train:")){

let [q,a]=text.replace("train:","").split("|");

db.memory[q.trim()] = a.trim();
vectorStore(q.trim(),a.trim());
save();

if(window.saveCloudMemory){
saveCloudMemory();
}

return "Training Saved";
}

let vec=vectorSearch(text);
if(vec) return vec;

if(db.memory[text]) return db.memory[text];

return "ü§ñ Awaiting Training or Cloud Brain";

}

/* ===== SEND ===== */

async function send(){

let msg=input.value.trim();
if(!msg) return;

add("user",msg);
add("ai","Thinking...");

let reply=await think(msg);

chat.removeChild(chat.lastChild);
add("ai",reply);

input.value="";
input.blur();

}

/* ===== SIDEBAR SWIPE ===== */

let startX=0;

document.body.addEventListener("touchstart",e=>{
startX=e.touches[0].clientX;
});

document.body.addEventListener("touchend",e=>{

let endX=e.changedTouches[0].clientX;
let sidebar=document.getElementById("sidebar");

if(startX<50 && endX>120){
sidebar.classList.add("open");
}

if(startX>200 && endX<120){
sidebar.classList.remove("open");
}

});

/* ===== START ===== */

loadTabs();
loadChat();
add("ai","üöÄ JARVIS CORE ONLINE");

</script>

<!-- ===== CLOUD MODULE ===== -->

<script type="module">

import { jarvisLogin, saveCloudMemory, getUserEmail } from "./cloudSync.js";

window.jarvisLogin = async ()=>{
await jarvisLogin();
let email = await getUserEmail();
document.getElementById("userEmail").innerText = email || "Logged In";
};

window.saveCloudMemory = saveCloudMemory;

</script>

<script>

if('serviceWorker' in navigator){
navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html>
